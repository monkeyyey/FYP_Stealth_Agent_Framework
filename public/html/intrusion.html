<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <script
            src="https://kit.fontawesome.com/f5ac354cb0.js"
            crossorigin="anonymous"
        ></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <link
            rel="stylesheet"
            href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
            integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
            crossorigin="anonymous"
        />
        <link href="/css/intrusion.css" rel="stylesheet" />

        <script
            src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
            integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"
        ></script>

        <!-- For datepicker -->
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"
            integrity="sha512-T/tUfKSV1bihCnd+MxKD0Hm1uBBroVYBOYSk1knyvQ9VyZJpc/ALb4P0r6ubwVPSGB2GvjeoMAJJImBG12TiaQ=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        ></script>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.standalone.min.css"
            integrity="sha512-TQQ3J4WkE/rwojNFo6OJdyu6G8Xe9z8rMrlF9y7xpFbQfW5g8aSWcygCQ4vqRiJqFsDsE1T6MoAOMJkFXlrI9A=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        />
        <script
            src="https://kit.fontawesome.com/801503bc53.js"
            crossorigin="anonymous"
        ></script>

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"
            integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"
            integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k"
            crossorigin="anonymous"
        ></script>
        <link
            rel="stylesheet"
            href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css"
        />
        <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>

        <!-- dropdown select -->
        <link
            href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
            rel="stylesheet"
        />
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        <script src="/js/intrusion.js" defer></script>

        <script>
            axios
                .post(`${adminurl}/api/auth/adminaccess`, {
                    token: localStorage.getItem("jwt_token"),
                })
                .then((response) => {
                    if (response.data.access == 0) {
                        window.location.href = "/";
                    }
                });
        </script>
    </head>

    <body id="body">
        <nav
            class="navbar navbar-expand-md navbar-dark bg-dark"
            style="z-index: 3"
        >
            <a class="navbar-brand ml-4" href="/">Stealth Monkey</a>
            <button
                class="navbar-toggler"
                type="button"
                data-toggle="collapse"
                data-target="#navbarContent"
            ></button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav md-auto" id="navbarr">
                    <li class="nav-item">
                        <a class="nav-link" href="/home">Home</a>
                    </li>
                    <li class="nav-item pr-2">
                        <a class="nav-link" href="/intrusion_detection"
                            >Intrusion</a
                        >
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/security_analytics"
                            >Analytics</a
                        >
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/file_permission"
                            >Permission</a
                        >
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/file_integrity">Integrity</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/custom">Custom</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/virustotal">File Scan</a>
                    </li>
                    <li class="nav-item">
                        <a href="/register" class="nav-link">Register</a>
                    </li>
                    <li class="nav-item">
                        <a href="/agents" class="nav-link">Agents</a>
                    </li>
                    <li class="nav-item">
                        <a href="/profiles" class="nav-link">Profiles</a>
                    </li>
                    <li class="bg-danger rounded ml-2">
                        <a onclick="logout()" href="/login" class="nav-link"
                            >Logout</a
                        >
                    </li>
                </ul>
            </div>
        </nav>

        <div class="container">
            <div class="row justify-content-center">
                <table
                    class="mt-4 table table-hover table-dark col-md-12"
                    id="agent-table"
                >
                    <thead class="text-warning">
                        <tr>
                            <th scope="col">Agent Name</th>
                            <th scope="col">IP address</th>
                            <th scope="col">Port</th>
                            <th scope="col">Status</th>
                            <th scope="col">Last Status update</th>
                            <th scope="col">Uptime</th>
                            <th scope="col">Scan</th>
                        </tr>
                    </thead>
                    <tbody id="agents"></tbody>
                </table>
            </div>

            <div
                class="row justify-content-center col-12 border border-secondary"
                id="show_all"
            >
                <div class="col-12">
                    <h2>Chkrootkit Alerts</h2>
                    <div class="col-12 p-4 justify-content-center text-center">
                        <label for="action">Filter by Agent:</label>
                        <select name="filter-agent" id="filter-agent"></select>
                        <button
                            id="agent-filter"
                            class="btn btn-warning"
                            onclick="filter()"
                        >
                            Filter
                        </button>

                        <label for="filter-date" name="filterDate"
                            >Filter by Date:</label
                        >
                        <input id="filter-date" type="date" />
                        <button
                            id="date-filter"
                            class="btn btn-warning"
                            onclick="dateFilter()"
                        >
                            Filter
                        </button>

                        <label for="filterSearch">Search by Warning: </label>
                        <input
                            id="filterSearch"
                            name="filterSearch"
                            type="text"
                        />
                        <button
                            id="search-btn"
                            class="btn btn-warning"
                            onclick="filterSearch()"
                        >
                            Search
                        </button>
                    </div>
                    <table class="table table-hover table-dark" id="chk_table">
                        <thead>
                            <tr class="text-warning">
                                <th scope="col">#</th>
                                <th scope="col">Agent name</th>
                                <th scope="col">Agent IP</th>
                                <th scope="col">Warning</th>
                                <th scope="col">Date</th>
                            </tr>
                        </thead>
                        <tbody id="chkrootkit"></tbody>
                    </table>
                </div>
            </div>
            <div
                class="row justify-content-center col-12 border border-secondary"
                id="show_all"
            >
                <div class="col-12">
                    <h2>Snort Alerts</h2>
                    <table class="table table-hover table-dark">
                        <thead>
                            <tr class="text-warning">
                                <th scope="col">Agent Name</th>
                                <th scope="col">Agent IP</th>
                                <th scope="col">Date time</th>
                                <th scope="col">Message</th>
                                <th scope="col">Priority</th>
                                <th scope="col">Source IP</th>
                                <th scope="col">Source port</th>
                                <th scope="col">Destination IP</th>
                                <th scope="col">Destination port</th>
                            </tr>
                        </thead>
                        <tbody id="snort"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <footer
            class="text-center text-lg-start pt-4 bg-dark text-secondary"
            style="
                background: rgb(0, 0, 0);
                background: linear-gradient(
                    180deg,
                    rgba(12, 12, 12, 1) 20%,
                    rgba(16, 16, 16, 1) 70%,
                    rgba(24, 24, 24, 1) 100%
                );
            "
        >
            <div class="container p-4 w-100 text-center justify-content-center">
                <div class="row col-xl-12">
                    <div class="col-xl-8 col-lg-6 col-md-12 text-left">
                        <h3 class="col-xl-12 text-light">About Us</h3>
                        <div class="col-xl-12">
                            <p>
                                <b>Stelf on the Shelf</b> Stelf on the Shelf is
                                a Proof-of-Concept (POC) project, a framework
                                that can be applied to gather runtime system
                                configuration and status for a targeted system
                                in stealth mode. With the framework in place, a
                                system administrator can monitor and gather
                                vital system information for malware and/or
                                intrusion detection at the EndPoint level.
                            </p>
                        </div>
                    </div>
                    <div class="col-xl-4 col-md-12 text-left">
                        <h3 class="text-light">Social Media</h3>
                        <a href="https://www.instagram.com/stealth_shelf/"
                            ><i class="fab fa-instagram"></i>&nbsp Instagram</a
                        >
                        <br />
                        <a href="https://www.sp.edu.sg/"
                            ><i class="fa-solid fa-graduation-cap"></i>&nbsp
                            Singapore Polytechnic</a
                        >
                        <br />
                        <a
                            href="https://github.com/monkeyyey/stelf_on_the_shelf"
                            ><i class="fab fa-github"></i>&nbsp Find us on
                            Github!</a
                        >
                        <br />
                    </div>
                </div>
            </div>
            <div class="text-center pb-3 text-light">
                Â© 2022 Copyright:
                <a class="text-secondary" href="/home">Stelf on the Shelf</a>
            </div>
        </footer>
    </body>

    <script>
        function logout() {
            localStorage.clear();
        }

        var current_ip = "";
        var today = new Date();
        var date =
            today.getFullYear() +
            "-" +
            (today.getMonth() + 1) +
            "-" +
            today.getDate();
        var time =
            today.getHours() +
            "." +
            today.getMinutes() +
            "." +
            today.getSeconds();
        var dateTime = date + "_" + time;

        axios.get(`/api/agents/get_agents`).then((response) => {
            const agentObject = response.data;
            var status = "";
            var current_time = Math.floor(Date.now() / 1000);
            for (const x in agentObject) {
                if (agentObject[x]["scope"]) {
                    if (agentObject[x]["scope"].includes("2")) {
                        try {
                            var last_status_update = parseInt(
                                agentObject[x]["last_status_update"].split(
                                    "|"
                                )[1]
                            );
                            if (current_time - last_status_update < 60) {
                                status = "Running";
                            } else {
                                status = "Unreachable";
                            }
                        } catch {
                            status = "Unreachable";
                        }
                        if (!agentObject[x]["last_status_update"]) {
                            var last_status_update_time =
                                "No status update available";
                        } else {
                            var last_status_update_time =
                                agentObject[x]["last_status_update"].split(
                                    "|"
                                )[0];
                        }
                        if (
                            !agentObject[x]["uptime"] ||
                            status == "Unreachable"
                        ) {
                            var uptime = "No uptime available";
                        } else {
                            var uptime = agentObject[x]["uptime"].slice(0, -4);
                        }
                        $("#agents").append(`
                            <tr>
                                <td>${agentObject[x]["agent_name"]}</td>
                                <td>${agentObject[x]["agent_ip"]}</td>
                                <td>${agentObject[x]["port_number"]}</td>
                                <td><span class="bi bi-circle-fill ${status}" id="${agentObject[x]["agent_name"]}_status">${status}</span></td>
                                <td>${last_status_update_time}</td>
                                <td>${uptime}</td>
                                <td><button class="btn btn-warning btn-sm" onclick="agents(${agentObject[x]["agent_id"]}, ${agentObject[x]["port_number"]})">Scan for: ${agentObject[x]["agent_name"]}</button></td>
                            </tr>
                        `);
                        $("#agent-select").append(`
                            <option value="${agentObject[x]["agent_id"]}||${agentObject[x]["port_number"]}">${agentObject[x]["agent_name"]}</option>
                        `);

                        $("#filter-agent").append(`
                            <option value="${agentObject[x]["agent_name"]}">${agentObject[x]["agent_name"]}</option>
                        `);
                    }
                }
            }
        });

        function agents(id, port) {
            axios
                .get(`/api/intrusion/getChecksum/${id}/${port}`)
                .then((response) => {})
                .catch((error) => {
                    console.log(error);
                });
        }

        axios
            .get(`/api/intrusion/getchkrootkit`)
            .then((response) => {
                const result = response.data;

                result.forEach((result) => {
                    var id = result.id;
                    $("#chkrootkit").append(`
                <tr class="accordion-toggle">
                    <th scope="row">${result.id}</th>
                    <td scope="row">${result.agent_name}</td>
                    <td scope="row">${result.ip_address}</td>
                    <td>${result.results}</td>
                    <td>${result.created_at}</td>
                    <td><button type="button" class="btn btn-warning" data-toggle="collapse" data-target="#report${result.id}" aria-expanded="false" aria-controls="report${result.id}">view report</button></td>
                </tr>
                <tr>
                    <td colspan="12" class="hiddenRow">
                        <div id="report${id}" class="accordian-body collapse"> 
                           
                        </div>
                    </td>
                </tr>
            
                `);
                    axios
                        .get(
                            `/api/intrusion/chkrootkit_report/${result.report_id}`
                        )
                        .then((response) => {
                            const result = response.data;
                            var r = /\W+(?=[C|S])/g;
                            s = result.replace(r, "$&<br>");
                            $(`#report${id}`).append(
                                `
                            ${s}
                            `
                            );
                        })
                        .catch((error) => {
                            console.log(error);
                        });
                });
            })
            .catch((error) => {
                console.log(error);
            });

        function view_selfreport(ip, nickname) {
            // event.preventDefault()
            if (
                document.getElementById("self_table").style.display === "none"
            ) {
                document.getElementById("self_table").style.display = "block";
                axios
                    .get(`${adminurl}/api/intrusion/selfchkrootkit/${nickname}`)
                    .then((response) => {
                        const result = response.data;
                        $("#self_chkrootkit").empty();
                        result.forEach((result) => {
                            $("#self_chkrootkit").append(`
                        <tr>
                            <th scope="row">${result.agent_name}</th>
                            <td scope="row">${result.ip_address}</td>
                            <td>${result.results}</td>
                            <td>${result.created_at}</td>
                        </tr>
                        `);
                        });
                    })
                    .catch((error) => {
                        console.log(error);
                    });
            } else {
                document.getElementById("self_table").style.display = "none";
            }
        }

        //filters
        function filter() {
            var agentHtml = document.getElementById("filter-agent");
            var agent = agentHtml.value;
            axios.get(`/api/intrusion/agent/${agent}`).then((response) => {
                document.getElementById("chkrootkit").innerHTML = "";
                const result = response.data;
                if (result.length == 0) {
                    $("chkrootkit").append(`
                    <tr>
                        <td>NIL</td>
                        <td>NIL</td>
                        <td>NIL</td>
                        <td>NIL</td>
                        <td>NIL</td>
                        <td>NIL</td>
                    </tr>`);
                }

                result.forEach((result) => {
                    var agentid = result.id;

                    $("#chkrootkit").append(`
                <tr class="accordion-toggle">
                    <th scope="row">${result.id}</th>
                    <td scope="row">${result.agent_name}</td>
                    <td scope="row">${result.ip_address}</td>
                    <td>${result.results}</td>
                    <td>${result.created_at}</td>
                    <td><button type="button" class="btn btn-warning" data-toggle="collapse" data-target="#search${result.id}" aria-expanded="false" aria-controls="search${result.id}">view report</button></td>
                </tr>
                <tr>
                    <td colspan="12" class="hiddenRow">
                        <div id="search${agentid}" class="accordian-body collapse"> 
                           
                        </div>
                    </td>
                </tr>
            
                `);
                    axios
                        .get(
                            `/api/intrusion/chkrootkit_report/${result.report_id}`
                        )
                        .then((response) => {
                            const report = response.data;
                            var r = /\W+(?=[C|S])/g;
                            s = report.replace(r, "$&<br>");
                            $(`#search${agentid}`).append(
                                `
                            ${s}
                            `
                            );
                        })
                        .catch((error) => {
                            console.log(error);
                        });
                });
            });
        }

        function filterSearch(search) {
            var searchHtml = document.getElementById("filterSearch");
            var search = searchHtml.value;

            axios.get(`/api/intrusion/search/${search}`).then((response) => {
                document.getElementById("chkrootkit").innerHTML = "";
                const result = response.data;
                if (result.length == 0) {
                    $("#chkrootkit").append(`
                    <tr>
                        <td>NIL</td>
                        <td>NIL</td>
                        <td>NIL</td>
                        <td>NIL</td>
                        <td>NIL</td>
                    </tr>`);
                }

                result.forEach((result) => {
                    var agentid = result.id;

                    $("#chkrootkit").append(`
                <tr class="accordion-toggle">
                    <th scope="row">${result.id}</th>
                    <td scope="row">${result.agent_name}</td>
                    <td scope="row">${result.ip_address}</td>
                    <td>${result.results}</td>
                    <td>${result.created_at}</td>
                    <td><button type="button" class="btn btn-warning" data-toggle="collapse" data-target="#search${result.id}" aria-expanded="false" aria-controls="search${result.id}">view report</button></td>
                </tr>
                <tr>
                    <td colspan="12" class="hiddenRow">
                        <div id="search${agentid}" class="accordian-body collapse"> 
                           
                        </div>
                    </td>
                </tr>
            
                `);
                    axios
                        .get(
                            `/api/intrusion/chkrootkit_report/${result.report_id}`
                        )
                        .then((response) => {
                            const report = response.data;
                            var r = /\W+(?=[C|S])/g;
                            s = report.replace(r, "$&<br>");
                            $(`#search${agentid}`).append(
                                `
                            ${s}
                            `
                            );
                        })
                        .catch((error) => {
                            console.log(error);
                        });
                });
            });
        }

        function dateFilter(date) {
            var dateHtml = document.getElementById("filter-date");
            var date = dateHtml.value;
            axios.get(`api/intrusion/date/${date}`).then((response) => {
                document.getElementById("chkrootkit").innerHTML = "";
                const result = response.data;
                if (result.length == 0) {
                    $("#chkrootkit").append(`<tr>
                        <td>NIL</td>
                        <td>NIL</td>
                        <td>NIL</td>
                        <td>NIL</td>
                        <td>NIL</td>
                    </tr>`);
                }
                for (var i = 0; i < result.length; i++) {
                    $("#chkrootkit").append(`
                    <tr>
                        <td>${result[i].id}</td>
                        <td>${result[i].agent_name}</td>
                        <td>${result[i].ip_address}</td>
                        <td>${result[i].results}</td>
                        <td>${result[i].created_at}</td>
                    </tr>`);
                }
            });
        }
        // ++++++++++++++++++++++++++++++++++++++++++++++++++++++
        setInterval(function () {
            $('#snort').html("");
            // console.log("removing")
            axios.get(`/api/intrusion/getsnort`)
            .then((response) => {
                const result = response.data;
                $("snort").empty();


                result.forEach((result) => {
                    var id = result.id
                    $("#snort").append(`
                    <tr class="accordion-toggle">
                        <td scope="row">${result.id}</td>
                        <td scope="row">${result.agent_name}</td>
                        <td scope="row">${result.agent_ip}</td>
                        <td scope="row">${result.datetime}</td>
                        <td scope="row">${result.message}</td>
                        <td scope="row">${result.priority}</td>
                        <td scope="row">${result.src_ip}</td>
                        <td scope="row">${result.src_port}</td>
                        <td scope="row">${result.dest_ip}</td>
                        <td scope="row">${result.dest_port}</td>
                    </tr>
                
                
                    `);
                    
                })
            
                // $(document).ready(function () {
                //     $('#snort-table').DataTable({
                //         // "pageLength": 8,
                //         // order: [[0, 'desc']],
                //     });
                // });
                    
            })
            .catch((error) => {
            console.log(error);
            });

        }, 10000);
        axios
            .get(`/api/intrusion/getsnort`)
            .then((response) => {
                const result = response.data;

                result.forEach((result) => {
                    var id = result.id;
                    $("#snort").append(`
                <tr class="accordion-toggle">
                    <td scope="row">${result.id}</td>
                    <td scope="row">${result.agent_name}</td>
                    <td scope="row">${result.agent_ip}</td>
                    <td scope="row">${result.datetime}</td>
                    <td scope="row">${result.message}</td>
                    <td scope="row">${result.priority}</td>
                    <td scope="row">${result.src_ip}</td>
                    <td scope="row">${result.src_port}</td>
                    <td scope="row">${result.dest_ip}</td>
                    <td scope="row">${result.dest_port}</td>
                </tr>
              
            
                `);
                });

                $(document).ready(function () {
                    $("#snort-table").DataTable({
                        pageLength: 8,
                        order: [[0, "desc"]],
                    });
                });
            })
            .catch((error) => {
                console.log(error);
            });
        // ++++++++++++++++++++++++++++++++++++++++++++++++++++++
    </script>
</html>
